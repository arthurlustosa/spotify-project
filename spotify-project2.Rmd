---
title: "Untitled"
author: "Arthur"
date: "23 de abril de 2017"
output: html_document
---

```{r}
#instala o Rspotify
if(!require("Rspotify"))
  devtools::install_github("tiagomendesdantas/Rspotify")

#bibliotecas utilizadas
library(Rspotify)
library(magrittr)
library(forcats)
library(stringi)
library(lubridate)
library(httr)
library(rvest)
library(tidyverse)
library(dplyr)
library(tibble)  
library(lubridate)
library(purrr)  
library(tidyr)


devtools::install_github("soodoku/tuber", build_vignettes = TRUE)
vignette("tuber-ex", package="tuber")
library(tuber)        # Acesso a API do YouTube
library(streamgraph)

```


```{r}
#autenticação
keys <- spotifyOAuth("spotify-r-project","58fccb9a51434b5bab3cf8ce2274b997","4927c42e006a4c46a2308f79757bd582")
 


lolla2017_playlist <- getPlaylistSongs("lollabr", "1mHoPn6JpbtWtoBuvSXrVm", token = keys) %>%
  mutate(artistInfo = map(artistId, getArtistinfo),
         artist = artist %>% tolower) %>%
  rename(track_popularity = popularity,
         track_id = id) %>%
  unnest(artistInfo) %>%
  select(artist, id, name, popularity, followers)

#get playlist
#playlist Rainhas do Sertanejo owner = spotify | playlist_id = 37i9dQZF1DXcC14V9ZdJ9I
rainhas_do_sertanejo_playlist <- getPlaylistSongs("spotify", "37i9dQZF1DXcC14V9ZdJ9I", token = keys) %>%
  mutate(artistInfo = map(artistId, getArtistinfo),
         artist = artist %>% tolower) %>%
  rename(track_popularity = popularity,
         track_id = id) %>%
  unnest(artistInfo) %>%
  select(artist, id, name, popularity, followers)


esquenta_sertanejo_playlist <- getPlaylistSongs("spotify", "37i9dQZF1DXdSjVZQzv2tl", token = keys) %>%
  mutate(artistInfo = map(artistId, getArtistinfo),
         artist = artist %>% tolower) %>%
  rename(track_popularity = popularity,
         track_id = id) %>%
  unnest(artistInfo) %>%
  select(artist, id, name, popularity, followers)

ranking_divas_sertanejas <- rainhas_do_sertanejo_playlist %>%
  group_by(artist) %>%
  summarise(artist_ = first(artist),
            id_ = first(id),
            popularity_ = first(popularity))

ranking_sertanejo <- esquenta_sertanejo_playlist %>%
  group_by(artist) %>%
  summarise(artist_ = first(artist),
            id_ = first(id),
            popularity_ = first(popularity))

```
```


```{r}
# MariliaMendonça UCwfEOn0O1DWcyTgzVVu28ig
# Maiara_e_Maraisa UCULzCZWkkOb9dW8rr6dguQQ
# Simone_e_Simaria UCI4hPnUgXDCx1ebNDaM8_5Q
# NaiaraAzevedo UCOfSEIUbEcOCMGPGyMPv4fg
# Day_e_Lara UCd8mmNUy80y8n0wFgTCjC3A
# PaulaFernandes UC1_7Qeu1LdDy5PTZ0vQE_sA
# PaulaMattos UCMTUSMqhB0jDbcbyXZtcyFw
# Wanessa UCmYVJBJV1fQgbgbfD0_VAhg
# Julia_e_Rafaela UCG3u7pFuzyGjgkp0Ay378yA
# BrunaViola UCl5pVPN7enAlN7ggYWNVoPQ
# RobertaMiranda UCIaO7yvRbgBlx3JyLRRrtGA
# May_e_Karen UCtWzhHO4T1VGfJfGXGEd5XQ
# Thaeme UCor5q_SJKxPjg6SQxotXMzQ
# MylenaJardin UCGTM9Y6OwRYBe-7eNFqX-lg
# FernandaCosta UCu7F4QH_NehaYdDbeXNhbkw
# Lais UC4tTBuX5h1TVCb144JeRw6A
# Lola_e_Vitoria 
# Bruna_e_Keyla UCnDC6XP6F6HuOj0yCauMQjg
# InezitaBarroso
# SuellenSantos UCQdlfEn8qhrDFHqUQ4VTsWA
# TutaGuedes UCnXjJSjWW5WUKABJ8Y7KPYQ

```


```{r}
yt_oauth(app_id = "273807722068-unnpeh2c9dju03oqjutnbnu9ogd4bcv7.apps.googleusercontent.com",
        app_secret = "QKhOlvht_TDhrWhSpleTMEA8")

get_videos <- function(dates, id_channel) {
  yt_search(term = "", 
            type = "video",
            channel_id = id_channel,
            published_after = dates$start,
            published_before = dates$end)
}

dates <- tibble(start = seq(ymd("2008-01-01"), ymd("2017-01-01"), by = "years"),
                        end = seq(ymd("2008-12-31"), ymd("2017-12-31"), by = "years")) %>% 
  mutate(start = paste(start, "T0:00:00Z", sep = ""),
         end = paste(end, "T0:00:00Z", sep = ""))
```

```{r}
videos_MariliaMendonca <- by_row(.d = dates, "UCwfEOn0O1DWcyTgzVVu28ig", ..f = get_videos, .to = "videos_info")
videos_Maiara_e_Maraisa <- by_row(.d = dates, "UCULzCZWkkOb9dW8rr6dguQQ", ..f = get_videos, .to = "videos_info")
videos_Simone_e_Simaria <- by_row(.d = dates, "UCI4hPnUgXDCx1ebNDaM8_5Q", ..f = get_videos, .to = "videos_info")
videos_NaiaraAzevedo <- by_row(.d = dates, "UCOfSEIUbEcOCMGPGyMPv4fg", ..f = get_videos, .to = "videos_info")
videos_Day_e_Lara <- by_row(.d = dates, "UCd8mmNUy80y8n0wFgTCjC3A", ..f = get_videos, .to = "videos_info")
videos_PaulaFernandes <- by_row(.d = dates, "UC1_7Qeu1LdDy5PTZ0vQE_sA", ..f = get_videos, .to = "videos_info")
videos_PaulaMattos <- by_row(.d = dates, "UCMTUSMqhB0jDbcbyXZtcyFw", ..f = get_videos, .to = "videos_info")
videos_Wanessa <- by_row(.d = dates, "UCmYVJBJV1fQgbgbfD0_VAhg", ..f = get_videos, .to = "videos_info")
videos_Julia_e_Rafaela <- by_row(.d = dates, "UCG3u7pFuzyGjgkp0Ay378yA", ..f = get_videos, .to = "videos_info")
videos_BrunaViola <- by_row(.d = dates, "UCl5pVPN7enAlN7ggYWNVoPQ", ..f = get_videos, .to = "videos_info")
videos_RobertaMiranda <- by_row(.d = dates, "UCIaO7yvRbgBlx3JyLRRrtGA", ..f = get_videos, .to = "videos_info")
videos_May_e_Karen <- by_row(.d = dates, "UCtWzhHO4T1VGfJfGXGEd5XQ", ..f = get_videos, .to = "videos_info")
videos_Thaeme <- by_row(.d = dates, "UCor5q_SJKxPjg6SQxotXMzQ", ..f = get_videos, .to = "videos_info")
videos_MylenaJardin <- by_row(.d = dates, "UCGTM9Y6OwRYBe-7eNFqX-lg", ..f = get_videos, .to = "videos_info")
videos_FernandaCosta <- by_row(.d = dates, "UCu7F4QH_NehaYdDbeXNhbkw", ..f = get_videos, .to = "videos_info")
videos_Lais <- by_row(.d = dates, "UC4tTBuX5h1TVCb144JeRw6A", ..f = get_videos, .to = "videos_info")
videos_Bruna_e_Keyla <- by_row(.d = dates, "UCnDC6XP6F6HuOj0yCauMQjg", ..f = get_videos, .to = "videos_info")
videos_SuellenSantos <- by_row(.d = dates, "UCQdlfEn8qhrDFHqUQ4VTsWA", ..f = get_videos, .to = "videos_info")
videos_TutaGuedes <- by_row(.d = dates, "UCnXjJSjWW5WUKABJ8Y7KPYQ", ..f = get_videos, .to = "videos_info")
```

```{r}
#pegando estatísticas dos vídeos
get_videos_stats <- function(df_row) {
  get_stats(video_id = df_row$video_id)
}
```

```{r}
dados_MariliaMendonca <- bind_rows(videos_MariliaMendonca$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_Maiara_e_Maraisa <- bind_rows(videos_Maiara_e_Maraisa$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_Simone_e_Simaria <- bind_rows(videos_Simone_e_Simaria$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_NaiaraAzevedo <- bind_rows(videos_NaiaraAzevedo$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_Day_e_Lara <- bind_rows(videos_Day_e_Lara$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_PaulaFernandes <- bind_rows(videos_PaulaFernandes$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_PaulaMattos <- bind_rows(videos_PaulaMattos$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_Wanessa <- bind_rows(videos_Wanessa$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_Julia_e_Rafaela <- bind_rows(videos_Julia_e_Rafaela$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_BrunaViola <- bind_rows(videos_BrunaViola$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_RobertaMiranda <- bind_rows(videos_RobertaMiranda$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_May_e_Karen <- bind_rows(videos_May_e_Karen$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_Thaeme <- bind_rows(videos_Thaeme$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_MylenaJardin <- bind_rows(videos_MylenaJardin$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_FernandaCosta <- bind_rows(videos_FernandaCosta$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_Lais <- bind_rows(videos_Lais$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_Bruna_e_Keyla <- bind_rows(videos_Bruna_e_Keyla$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_SuellenSantos <- bind_rows(videos_SuellenSantos$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

dados_TutaGuedes <- bind_rows(videos_TutaGuedes$videos_info) %>% 
  select(title, publishedAt, video_id) %>%
  by_row(..f = get_videos_stats, .to = "videos_stats")

videos_stats <- function(data, name){
   data %>% 
   mutate(views = map(videos_stats, .f = 'viewCount')) %>% 
   unnest(views )%>% 
   mutate(views = as.numeric(views),
           publishedAt = as_date(publishedAt),
           Nome = name)
  
}


#pegando estatisticas dos videos de cada cantora 
videos_stats_MariliaMendonca <- videos_stats(dados_MariliaMendonca, "Marilia Mendonça")
videos_stats_Maiara_e_Maraisa <- videos_stats(dados_Maiara_e_Maraisa, "Maiara e Maraisa")
videos_stats_Simone_e_Simaria <- videos_stats(dados_Simone_e_Simaria, "Simone e Simaria")
videos_stats_NaiaraAzevedo <- videos_stats(dados_NaiaraAzevedo, "Naiara Azevedo")
videos_stats_Day_e_Lara <- videos_stats(dados_Day_e_Lara, "Day e Lara")
videos_stats_PaulaFernandes <- videos_stats(dados_PaulaFernandes, "Paula Fernandes")
videos_stats_PaulaMattos <- videos_stats(dados_PaulaMattos, "Paula Mattos")
videos_stats_Wanessa <- videos_stats(dados_Wanessa, "Wanessa")
videos_stats_Julia_e_Rafaela <- videos_stats(dados_Julia_e_Rafaela, "Julia e Rafaela")
videos_stats_BrunaViola <- videos_stats(dados_BrunaViola, "Bruna Viola")
videos_stats_RobertaMiranda <- videos_stats(dados_RobertaMiranda, "Roberta Miranda")
videos_stats_May_e_Karen <- videos_stats(dados_May_e_Karen, "May e Karen")
videos_stats_Thaeme <- videos_stats(dados_Thaeme, "Thaeme")
#videos_stats_MylenaJardin <- videos_stats(dados_MylenaJardin, "Mylena Jardin")
videos_stats_FernandaCosta <- videos_stats(dados_FernandaCosta, "Fernanda Costa")
videos_stats_Lais <- videos_stats(dados_Lais, "Lais")
#videos_stats_Bruna_e_Keyla <- videos_stats(dados_Bruna_e_Keyla, "Bruna e Keyla")
videos_stats_SuellenSantos <- videos_stats(dados_SuellenSantos, "Suellen Santos")
videos_stats_TutaGuedes <- videos_stats(dados_TutaGuedes, "Tuta Guedes")


#montando dataset com as estatísticas de todos os vídeos
videos_stats_RainhasSertanejo <- rbind(
          videos_stats_MariliaMendonca,
          videos_stats_Maiara_e_Maraisa,
          videos_stats_Simone_e_Simaria,
          videos_stats_NaiaraAzevedo,
          videos_stats_Day_e_Lara,
          videos_stats_PaulaFernandes,
          videos_stats_PaulaMattos,
          videos_stats_Wanessa,
          videos_stats_Julia_e_Rafaela,
          videos_stats_BrunaViola,
          videos_stats_RobertaMiranda,
          videos_stats_May_e_Karen,
          videos_stats_Thaeme,
          videos_stats_FernandaCosta,
          videos_stats_Lais,
          videos_stats_SuellenSantos,
          videos_stats_TutaGuedes 
        )

#rainhas_sertanejo <- videos_stats_RainhasSertanejo %>%
#  select(Nome, title, publishedAt, video_id, views)
#write.csv(rainhas_sertanejo, "rainhas_sertanejo", row.names = F)
#write.csv(resume_divas_pop, "info_videos_geral.csv", row.names = F)

resume_rainhas_sertanejo <- rainhas_sertanejo %>%
  mutate(ano = format(publishedAt,'%Y')) %>%
  group_by(Nome, ano) %>%
  summarise(total_views = sum(views))

#write.csv(resume_rainhas_sertanejo, "info_videos_geral.csv", row.names = F)

library(streamgraph)
streamgraph(resume_rainhas_sertanejo, "Nome", "total_views", "ano")%>%
  sg_axis_x(1, "year", "%Y") %>%
  sg_axis_y(1, 5) %>%
  sg_legend(TRUE, "Cantora: ")
```
